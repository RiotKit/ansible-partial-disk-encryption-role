#!/bin/bash

#
# This file is automatically generated by Ansible
# All changes made manually to this file will be LOST!
#

### GENERATED BY ANSIBLE
MAPPED_DEVICE_PATH=/dev/mapper/{{ enc_mount_name }}
LOOPBACK_CACHE_PATH=/tmp/{{ enc_mount_name }}
ENC_FILE={{ enc_file }}
MOUNT_PATH=/mnt/{{ enc_mount_name }}
MOUNT_NAME={{ enc_mount_name }}
MOUNT_FS={{ enc_file_filesystem }}
### END OF GENERATED BY ANSIBLE

reformat () {
    mkfs.${MOUNT_FS} ${MAPPED_DEVICE_PATH}
}

setup_loopback () {
    # at first deactivate all previously assigned loopback devices
    for prev_loopback in $(losetup -a |grep "${ENC_FILE}" | cut -d":" -f1); do
        losetup -d ${prev_loopback}
    done

    loopback_device=$(losetup -f)
    losetup ${loopback_device} ${ENC_FILE} > /dev/null
    echo ${loopback_device}
}

mount_mapped_volume () {
    mkdir -p ${MOUNT_PATH}
    mount ${MAPPED_DEVICE_PATH} ${MOUNT_PATH}/
}

umount_previously_mounted_volume () {
    if [[ -d ${MOUNT_PATH} ]]; then
        umount ${MOUNT_PATH} 2> /dev/null
    fi

    if [[ -e ${MAPPED_DEVICE_PATH} ]]; then
        echo " .. Closing the previously opened device"
        cryptsetup close ${MAPPED_DEVICE_PATH}
    fi
}

decrypt () {
    passphrase=$1
    loopback_device=$(setup_loopback)

    tc-mount-volume.sh "${MOUNT_NAME} -d ${loopback_device}" ${passphrase}
    sleep 1

    if [[ ! -e ${MAPPED_DEVICE_PATH} ]]; then
        echo " .. Cannot decrypt volume"
        exit 1
    fi
}

main () {
    echo " >> Mounting ${MOUNT_NAME}"

    if [[ ! ${1} ]]; then
        echo "You need to specifiy the passphrase as the first parameter"
        exit 1
    fi

    umount_previously_mounted_volume
    decrypt ${1}

    if [[ ${2} == "--format" ]]; then
        reformat
    fi

    mount_mapped_volume
    verify_and_exit
}

verify_and_exit () {
    if mount | grep ${MOUNT_PATH} > /dev/null; then
        exit 0
    fi

    echo " .. Cannot find ${MOUNT_PATH} in the list of active mount points"
    exit 1
}

main "$@"
